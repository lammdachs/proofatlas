# Example: Selective Testing Based on Changed Files
# This shows different strategies for running only relevant tests in CI/CD

name: Selective Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # ============================================================================
  # Strategy 1: Path Filters - Trigger specific jobs based on changed paths
  # ============================================================================

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      python: ${{ steps.filter.outputs.python }}
      ml: ${{ steps.filter.outputs.ml }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            rust:
              - 'rust/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            python:
              - 'python/**'
              - 'setup.py'
              - 'pyproject.toml'
            ml:
              - 'python/proofatlas/ml/**'
              - 'python/tests/ml/**'
            docs:
              - 'docs/**'
              - '**/*.md'

  # Run Rust tests only if Rust files changed
  rust-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Run Rust tests
        run: |
          cd rust
          cargo test --lib
          cargo test --test '*'

  # Run Python tests only if Python files changed
  python-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest torch torch-geometric
      - name: Run Python tests
        run: pytest python/tests/

  # Run only ML tests if only ML files changed
  ml-tests:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.ml == 'true' &&
      needs.detect-changes.outputs.rust == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest torch torch-geometric
      - name: Run only ML tests
        run: pytest python/tests/ml/ -v

  # Skip tests for docs-only changes
  docs-only:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.docs == 'true' &&
      needs.detect-changes.outputs.rust == 'false' &&
      needs.detect-changes.outputs.python == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Docs only - skip tests
        run: echo "Only documentation changed, skipping tests"

  # ============================================================================
  # Strategy 2: Dynamic Test Selection Based on Changed Files
  # ============================================================================

  smart-testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Get full history for diff

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.sha }}
            HEAD=${{ github.event.pull_request.head.sha }}
          else
            BASE=${{ github.event.before }}
            HEAD=${{ github.sha }}
          fi

          CHANGED_FILES=$(git diff --name-only $BASE $HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Detect which test suites to run
          RUN_RUST=false
          RUN_PYTHON=false
          RUN_ML=false

          echo "$CHANGED_FILES" | while read file; do
            case $file in
              rust/src/core/*|rust/src/inference/*)
                echo "run_rust=true" >> $GITHUB_OUTPUT
                ;;
              rust/src/ml/*|python/proofatlas/ml/*)
                echo "run_ml=true" >> $GITHUB_OUTPUT
                ;;
              python/*)
                echo "run_python=true" >> $GITHUB_OUTPUT
                ;;
            esac
          done

      - name: Run targeted tests
        run: |
          # Install based on what changed
          if [ "${{ steps.changed-files.outputs.run_rust }}" = "true" ]; then
            cd rust && cargo test
          fi

          if [ "${{ steps.changed-files.outputs.run_python }}" = "true" ]; then
            pip install -e .
            pytest python/tests/
          fi

          if [ "${{ steps.changed-files.outputs.run_ml }}" = "true" ]; then
            pip install -e .
            pip install torch torch-geometric
            pytest python/tests/ml/
          fi

  # ============================================================================
  # Strategy 3: Test Impact Analysis - Run tests that import changed modules
  # ============================================================================

  impact-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install pytest-testmon
        run: |
          pip install pytest-testmon
          pip install -e .

      - name: Run only affected tests
        run: |
          # pytest-testmon tracks which tests exercise which code
          # and only runs tests affected by changes
          pytest --testmon

  # ============================================================================
  # Strategy 4: Matrix Testing with Conditional Jobs
  # ============================================================================

  matrix-selective:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-suite:
          - { name: "rust-core", path: "rust/src/core", command: "cargo test --lib" }
          - { name: "rust-ml", path: "rust/src/ml", command: "cargo test ml::" }
          - { name: "python-ml", path: "python/proofatlas/ml", command: "pytest python/tests/ml/" }
          - { name: "python-interface", path: "python/tests", command: "pytest python/tests/test_interface.py" }
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if test suite should run
        id: should-run
        run: |
          # Check if any files in this test suite's path changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -q "${{ matrix.test-suite.path }}" && echo "true" || echo "false")
          echo "run=$CHANGED" >> $GITHUB_OUTPUT

      - name: Run tests
        if: steps.should-run.outputs.run == 'true'
        run: ${{ matrix.test-suite.command }}

  # ============================================================================
  # Strategy 5: Caching and Incremental Testing
  # ============================================================================

  cached-testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Cache test results
      - name: Cache pytest results
        uses: actions/cache@v3
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-${{ hashFiles('python/**/*.py') }}

      # Cache Cargo build
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo
            rust/target
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with cache
        run: |
          # Only rebuild/retest what changed
          cargo test --all
          pytest python/tests/ --lf  # --lf = last failed

  # ============================================================================
  # Strategy 6: Always run critical tests, selective for others
  # ============================================================================

  tiered-testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Always run these critical tests
      - name: Critical tests (always run)
        run: |
          cargo test --lib core::
          pytest python/tests/test_interface.py

      # Run extended tests only if relevant files changed
      - name: Get changed files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Extended tests (conditional)
        if: contains(steps.changes.outputs.files, 'rust/src/ml/')
        run: |
          cargo test ml::
          pytest python/tests/ml/

  # ============================================================================
  # Best Practice: Combined Approach
  # ============================================================================

  smart-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup
        run: |
          # Install dependencies
          pip install pytest pytest-xdist  # parallel testing

      - name: Detect changes and run appropriate tests
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          # Default: run quick smoke tests
          TEST_ARGS="python/tests/test_interface.py::test_basic_proof"

          # Check what changed
          if echo "$CHANGED_FILES" | grep -q "rust/src/core\|rust/src/inference"; then
            # Core logic changed - run all Rust tests
            cargo test --all
            TEST_ARGS="python/tests/"
          elif echo "$CHANGED_FILES" | grep -q "rust/src/ml\|python/proofatlas/ml"; then
            # ML code changed - run ML tests only
            cargo test ml::
            TEST_ARGS="python/tests/ml/"
          elif echo "$CHANGED_FILES" | grep -q "python/"; then
            # Python-only changes
            TEST_ARGS="python/tests/"
          fi

          # Run Python tests (if any)
          if [ "$TEST_ARGS" != "" ]; then
            pytest $TEST_ARGS -n auto  # parallel execution
          fi
