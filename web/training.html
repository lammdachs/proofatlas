<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training - ProofAtlas</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .results-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .run-selector {
            margin-bottom: 20px;
        }

        .run-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            min-width: 300px;
        }

        .run-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .run-info h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .run-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .meta-item {
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .meta-item .label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .meta-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .chart-container h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .eval-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .eval-table th,
        .eval-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .eval-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .eval-table tr:hover {
            background: #f8f9fa;
        }

        .success-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .success-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .success-badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .config-item {
            font-size: 14px;
        }

        .config-item .key {
            color: #7f8c8d;
        }

        .config-item .val {
            font-weight: 600;
            color: #2c3e50;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .compare-section {
            margin-top: 30px;
        }

        .compare-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .run-meta {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="hero" style="padding: 20px;">
            <h1>Training</h1>
            <p class="tagline">Interactive visualization of model training runs</p>
            <nav class="main-nav">
                <a href="index.html">Home</a>
                <a href="results.html">Results</a>
                <a href="training.html">Training</a>
                <a href="docs.html">Docs</a>
                <a href="https://github.com/lexpk/proofatlas">GitHub</a>
            </nav>
        </header>

        <div class="results-container">
            <div class="run-selector">
                <label for="run-select">Select Run: </label>
                <select id="run-select">
                    <option value="">Loading runs...</option>
                </select>
                <button id="compare-btn" style="margin-left: 10px; padding: 10px 15px;">Compare Runs</button>
            </div>

            <div id="loading" class="loading">Loading training data...</div>

            <div id="results-content" style="display: none;">
                <div class="run-info" id="run-info">
                    <h2 id="run-name">Run Name</h2>
                    <div class="run-meta" id="run-meta"></div>
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #3498db;">Configuration</summary>
                        <div class="config-grid" id="config-grid" style="margin-top: 10px;"></div>
                    </details>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Training & Validation Loss</h3>
                        <div class="chart-wrapper">
                            <canvas id="loss-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>Validation Accuracy</h3>
                        <div class="chart-wrapper">
                            <canvas id="acc-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>Learning Rate</h3>
                        <div class="chart-wrapper">
                            <canvas id="lr-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container" id="proof-chart-container">
                        <h3>Proof Success Rate</h3>
                        <div class="chart-wrapper">
                            <canvas id="proof-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="eval-details" style="display: none;">
                    <h3>Evaluation Details</h3>
                    <table class="eval-table" id="eval-table">
                        <thead>
                            <tr>
                                <th>Epoch</th>
                                <th>Success Rate</th>
                                <th>Problems Solved</th>
                                <th>Avg Time</th>
                            </tr>
                        </thead>
                        <tbody id="eval-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="no-data" class="no-data" style="display: none;">
                <h3>No Training Data Available</h3>
                <p>Training results will appear here after running experiments.</p>
                <p>See <a href="docs.html">documentation</a> for training instructions.</p>
            </div>

            <div class="compare-section" id="compare-section" style="display: none;">
                <h3>Run Comparison</h3>
                <div class="chart-container">
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="compare-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p class="footer-links">
                <a href="index.html">Home</a> |
                <a href="results.html">Results</a> |
                <a href="training.html">Training</a> |
                <a href="docs.html">Docs</a> |
                <a href="https://github.com/lexpk/proofatlas">GitHub</a>
            </p>
        </footer>
    </div>

    <script>
        // Chart instances
        let lossChart, accChart, lrChart, proofChart, compareChart;
        let allRuns = {};
        let currentRun = null;

        // Chart.js default options
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.color = '#7f8c8d';

        async function loadRuns() {
            try {
                // Load index of available runs
                const indexResponse = await fetch('data/training/index.json');
                if (!indexResponse.ok) {
                    showNoData();
                    return;
                }

                const index = await indexResponse.json();
                const runNames = index.runs || [];

                if (runNames.length === 0) {
                    showNoData();
                    return;
                }

                // Load each run file
                for (const runName of runNames) {
                    try {
                        const response = await fetch(`data/training/${runName}.json`);
                        if (response.ok) {
                            const run = await response.json();
                            allRuns[runName] = run;
                        }
                    } catch (e) {
                        console.warn(`Failed to load run ${runName}:`, e);
                    }
                }

                if (Object.keys(allRuns).length === 0) {
                    showNoData();
                    return;
                }

                populateRunSelector();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-content').style.display = 'block';

                // Select first run (most recent)
                const firstRun = Object.keys(allRuns).sort().reverse()[0];
                document.getElementById('run-select').value = firstRun;
                displayRun(firstRun);

            } catch (e) {
                console.error('Failed to load runs:', e);
                showNoData();
            }
        }

        function showNoData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('no-data').style.display = 'block';
        }

        function populateRunSelector() {
            const select = document.getElementById('run-select');
            select.innerHTML = '';

            for (const runName of Object.keys(allRuns).sort().reverse()) {
                const option = document.createElement('option');
                option.value = runName;
                option.textContent = runName;
                select.appendChild(option);
            }
        }

        function displayRun(runName) {
            currentRun = allRuns[runName];
            if (!currentRun) return;

            // Update run info
            document.getElementById('run-name').textContent = currentRun.name || runName;

            // Meta information
            const model = currentRun.model || {};
            const metaHtml = `
                <div class="meta-item">
                    <div class="label">Model Type</div>
                    <div class="value">${model.type || 'N/A'}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Architecture</div>
                    <div class="value">${model.hidden_dim || '?'}h × ${model.num_layers || '?'}L</div>
                </div>
                <div class="meta-item">
                    <div class="label">Best Epoch</div>
                    <div class="value">${currentRun.best_epoch ?? 'N/A'}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Best Val Loss</div>
                    <div class="value">${currentRun.best_val_loss?.toFixed(4) ?? 'N/A'}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Training Time</div>
                    <div class="value">${formatTime(currentRun.total_time_seconds)}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Epochs</div>
                    <div class="value">${currentRun.epochs?.length ?? 0}</div>
                </div>
                <div class="meta-item">
                    <div class="label">Termination</div>
                    <div class="value">${currentRun.termination_reason || 'N/A'}</div>
                </div>
            `;
            document.getElementById('run-meta').innerHTML = metaHtml;

            // Config - combine model and training params
            const training = currentRun.training || {};
            const configItems = [
                ...Object.entries(model).map(([k, v]) => ({ key: `model.${k}`, val: v })),
                ...Object.entries(training).map(([k, v]) => ({ key: `training.${k}`, val: v })),
            ].filter(item => item.val !== null && item.val !== undefined);
            const configHtml = configItems
                .map(item => `<div class="config-item"><span class="key">${item.key}:</span> <span class="val">${item.val}</span></div>`)
                .join('');
            document.getElementById('config-grid').innerHTML = configHtml;

            // Update charts
            updateCharts();
        }

        function updateCharts() {
            if (!currentRun || !currentRun.epochs) return;

            const epochs = currentRun.epochs;
            const labels = epochs.map(e => e.epoch);
            const trainLoss = epochs.map(e => e.train_loss);
            const valLoss = epochs.map(e => e.val_loss);
            const valAcc = epochs.map(e => e.val_acc);
            const lr = epochs.map(e => e.learning_rate);

            // Loss chart
            if (lossChart) lossChart.destroy();
            lossChart = new Chart(document.getElementById('loss-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Train Loss',
                            data: trainLoss,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.1,
                        },
                        {
                            label: 'Val Loss',
                            data: valLoss,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Epoch' } },
                        y: { title: { display: true, text: 'Loss' }, beginAtZero: false }
                    }
                }
            });

            // Accuracy chart
            if (accChart) accChart.destroy();
            accChart = new Chart(document.getElementById('acc-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Validation Accuracy',
                        data: valAcc,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Epoch' } },
                        y: { title: { display: true, text: 'Accuracy' }, min: 0, max: 1 }
                    }
                }
            });

            // Learning rate chart
            if (lrChart) lrChart.destroy();
            lrChart = new Chart(document.getElementById('lr-chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Learning Rate',
                        data: lr,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: true,
                        tension: 0.1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Epoch' } },
                        y: { title: { display: true, text: 'LR' }, type: 'logarithmic' }
                    }
                }
            });

            // Proof success chart
            const evals = currentRun.evaluations || [];
            if (evals.length > 0) {
                document.getElementById('proof-chart-container').style.display = 'block';
                document.getElementById('eval-details').style.display = 'block';

                const evalLabels = evals.map(e => e.epoch);
                const successRates = evals.map(e => e.success_rate);

                if (proofChart) proofChart.destroy();
                proofChart = new Chart(document.getElementById('proof-chart'), {
                    type: 'line',
                    data: {
                        labels: evalLabels,
                        datasets: [{
                            label: 'Proof Success Rate',
                            data: successRates,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            fill: true,
                            tension: 0.1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Epoch' } },
                            y: { title: { display: true, text: 'Success Rate' }, min: 0, max: 1 }
                        }
                    }
                });

                // Evaluation table
                const tbody = document.getElementById('eval-tbody');
                tbody.innerHTML = evals.map(e => `
                    <tr>
                        <td>${e.epoch}</td>
                        <td>${(e.success_rate * 100).toFixed(1)}%</td>
                        <td>${e.num_success} / ${e.num_problems}</td>
                        <td>${e.avg_time?.toFixed(2) ?? 'N/A'}s</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('proof-chart-container').style.display = 'none';
                document.getElementById('eval-details').style.display = 'none';
            }
        }

        function formatTime(seconds) {
            if (!seconds) return 'N/A';
            if (seconds < 60) return `${seconds.toFixed(0)}s`;
            if (seconds < 3600) return `${(seconds / 60).toFixed(1)}m`;
            return `${(seconds / 3600).toFixed(1)}h`;
        }

        function compareRuns() {
            const runNames = Object.keys(allRuns);
            if (runNames.length < 2) {
                alert('Need at least 2 runs to compare');
                return;
            }

            document.getElementById('compare-section').style.display = 'block';

            const datasets = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c'];

            runNames.forEach((runName, i) => {
                const run = allRuns[runName];
                if (!run.epochs) return;

                const label = run.model?.type
                    ? `${run.model.type} (${run.model.hidden_dim}h×${run.model.num_layers}L)`
                    : runName;
                datasets.push({
                    label: label,
                    data: run.epochs.map(e => ({ x: e.epoch, y: e.val_loss })),
                    borderColor: colors[i % colors.length],
                    fill: false,
                    tension: 0.1,
                });
            });

            if (compareChart) compareChart.destroy();
            compareChart = new Chart(document.getElementById('compare-chart'), {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Validation Loss Comparison' }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Epoch' } },
                        y: { title: { display: true, text: 'Val Loss' } }
                    }
                }
            });

            // Scroll to comparison
            document.getElementById('compare-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Event listeners
        document.getElementById('run-select').addEventListener('change', (e) => {
            displayRun(e.target.value);
        });

        document.getElementById('compare-btn').addEventListener('click', compareRuns);

        // Load data on page load
        loadRuns();
    </script>
</body>
</html>
